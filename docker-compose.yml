services:
  db:
    image: postgres:15
    container_name: kyntus_db_main
    restart: unless-stopped
    environment:
      POSTGRES_USER: kyntus_user
      POSTGRES_PASSWORD: kyntus_pass
      POSTGRES_DB: Kynt_fac_DB
      POSTGRES_SHARED_BUFFERS: 256MB
      POSTGRES_MAX_CONNECTIONS: 100
    ports:
      - "127.0.0.1:5433:5432"
    volumes:
      - kyntus_data:/var/lib/postgresql/data
      - ./backups:/backups
    networks:
      - kyntus_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kyntus_user -d Kynt_fac_DB"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgadmin:
    image: dpage/pgadmin4
    container_name: kyntus_pgadmin_
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@kyntus.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_LISTEN_ADDRESS: 0.0.0.0
      PGADMIN_LISTEN_PORT: 80
    ports:
      - "127.0.0.1:5051:80"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./pgadmin/servers.json:/pgadmin4/servers.json
    networks:
      - kyntus_net

  # ✅ NOUVEAU : Selenium Chrome stable
  selenium:
    image: selenium/standalone-chrome:latest
    container_name: kyntus_selenium
    restart: unless-stopped
    shm_size: 2gb
    networks:
      - kyntus_net
    # Optionnel : exposer pour debug (pas obligatoire)
    # ports:
    #   - "127.0.0.1:4444:4444"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:4444/status | grep -q 'ready'"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s

  backend:
    build:
      context: .
      dockerfile: Backend/Dockerfile
    container_name: kyntus_backend
    restart: unless-stopped
    env_file:
      - ./Backend/.env
    environment:
      # Variables attendues par Backend/core/config.py
      POSTGRES_USER: kyntus_user
      POSTGRES_PASSWORD: kyntus_pass
      POSTGRES_DB: Kynt_fac_DB
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      CORS_ORIGINS: "http://localhost:3100,http://127.0.0.1:3100"

      # ✅ NOUVEAU : Selenium remote
      SELENIUM_REMOTE_URL: "http://selenium:4444/wd/hub"

    working_dir: /app/Backend
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --workers 1
    volumes:
      - ./Backend:/app/Backend
      - backend_logs:/app/Backend/logs
    depends_on:
      db:
        condition: service_healthy
      selenium:
        condition: service_healthy
    ports:
      - "127.0.0.1:8100:8000"
    networks:
      - kyntus_net
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/').read()\""
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://localhost:8100
    container_name: kyntus_frontend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:8100
      NODE_ENV: development
      PORT: 3000
      HOSTNAME: 0.0.0.0
    volumes:
      - ./Frontend:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "127.0.0.1:3100:3000"
    networks:
      - kyntus_net
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

volumes:
  kyntus_data:
    driver: local
  pgadmin_data:
    driver: local
  backend_logs:
    driver: local

networks:
  kyntus_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/16